<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>JATSC Radio Visual Information System (JARVIS)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .polygon-label {
            font-weight: bold; color: #000; background-color: rgba(255,255,255,0.85);
            padding: 2px 5px; border-radius: 4px; font-size: 12px;
            box-shadow: 0 0 2px rgba(0,0,0,0.3);
        }
        #controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 8px; border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            width: 45vw; max-width: 220px; min-width: 180px;
            transition: transform 0.4s ease-in-out;
        }
        #controls strong { font-size: 13px; margin-bottom: 4px; display: block; }
        #controls .btn { padding: 3px 8px; font-size: 12px; }
        .select2-container--default .select2-selection--multiple { border: 1px solid #ccc; border-radius: 4px; }
        .select2-container { width: 100% !important; }
        #notification {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 2000; background-color: rgba(0, 0, 0, 0.75); color: white;
            padding: 10px 20px; border-radius: 20px; font-size: 14px;
            opacity: 0; visibility: hidden; transition: opacity 0.5s, visibility 0.5s;
        }
        #notification.show { opacity: 1; visibility: visible; }
        #toggle-controls-btn {
            position: absolute; top: 5px; left: -25px; width: 25px; height: 25px;
            background-color: white; border: 1px solid #ccc; border-right: none;
            border-radius: 5px 0 0 5px; cursor: pointer; display: flex;
            align-items: center; justify-content: center;
            box-shadow: -2px 1px 5px rgba(0,0,0,0.2);
        }
        #toggle-controls-btn i { transition: transform 0.4s; }
        #controls.is-hidden { transform: translateX(calc(100% + 15px)); }
        #controls.is-hidden #toggle-controls-btn i { transform: rotate(180deg); }
    </style>
</head>
<body>
    <div id="controls">
        <div id="toggle-controls-btn">
            <i class="fa fa-chevron-right"></i>
        </div>
        <strong>Filter Sektor:</strong>
        <select id="sector-select-box" class="form-control" multiple="multiple"></select>
        <strong style="margin-top: 10px;">Pencarian Data:</strong>
        <input type="text" id="search-box" class="form-control" placeholder="Cari callsign, lokasi...">
        <div class="text-center" style="margin-top:8px;">
            <button class="btn btn-sm btn-primary" onclick="selectAll(true)">Expand All</button>
            <button class="btn btn-sm btn-danger" onclick="selectAll(false)">Collapse All</button>
        </div>
    </div>

    <div id="notification"></div>
    <div id="map"></div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-qCWLhkjYc9IYNztAWPmPatlxhCqKzR8&callback=initMap"></script>
    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>

    <script>
    // --- INISIALISASI PETA & VARIABEL GLOBAL ---
    const map = L.map("map", { zoomControl: false }).setView([-2.5, 117.0], 5);
    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    const stationClusterGroup = L.markerClusterGroup();
    const logClusterGroup = L.markerClusterGroup();
    let polygonLayers = {}, sectorMarkers = {}, logMarkersBySector = {}, radioLogs = {}, mapConfig, fuse, coverageLayers = {};
    const visibleStyle = { opacity: 1, fillOpacity: 0.3 }, invisibleStyle = { opacity: 0, fillOpacity: 0 };

    // --- FUNGSI-FUNGSI HELPER ---
    function calculateDestinationPoint(lat, lon, bearing, distanceNm) { const R = 6371, distanceKm = distanceNm * 1.852; const latRad = (lat * Math.PI)/180, lonRad = (lon * Math.PI)/180, bearingRad = (bearing * Math.PI)/180; const lat2Rad = Math.asin(Math.sin(latRad) * Math.cos(distanceKm/R) + Math.cos(latRad) * Math.sin(distanceKm/R) * Math.cos(bearingRad)); const lon2Rad = lonRad + Math.atan2(Math.sin(bearingRad) * Math.sin(distanceKm/R) * Math.cos(latRad), Math.cos(distanceKm/R) - Math.sin(latRad) * Math.sin(lat2Rad)); return [(lat2Rad * 180)/Math.PI, (lon2Rad * 180)/Math.PI]; }
    function getReadabilityColor(r) { const n = parseInt(r, 10); if (n>=4) return 'green'; if (n>=2) return 'yellow'; if (n>=0) return 'red'; return 'grey'; }
    function formatDate(d) { if(typeof d==='string'&&d.includes('T')){d=new Date(d)} if(!(d instanceof Date)||isNaN(d)){return (typeof d==='string')?d.split('T')[0]:d} const D=String(d.getDate()).padStart(2,'0'),M=String(d.getMonth()+1).padStart(2,'0'),Y=d.getFullYear(); return `${D}/${M}/${Y}`}
    function showNotification(msg) { const n=document.getElementById('notification'); n.textContent=msg; n.classList.add('show'); setTimeout(()=>n.classList.remove('show'),3000) }
    
    // --- FUNGSI-FUNGSI UTAMA APLIKASI ---
    function loadDynamicData() { const apiUrl = 'https://script.google.com/macros/s/AKfycbysOsW_I0X2UxA6Gl0KwfFtFwG39imuqM4qfPPDl_alNh1TBWBIPB9kbbYvbKU3OZE/exec'; fetch(apiUrl).then(r=>r.json()).then(data=>{console.log("Data log dari GSheet:",data); const sMap={}; mapConfig.locations.forEach(l=>{sMap[l.varname.toUpperCase()]=l}); logClusterGroup.clearLayers(); logMarkersBySector={}; radioLogs={}; data.forEach(log=>{const v=(log.radio_id||"").trim().toUpperCase(),s=sMap[v]; if(v){if(!radioLogs[v]){radioLogs[v]=[]} radioLogs[v].push(log)} if(s&&log.radial!=null&&log.distance!=null){const d=calculateDestinationPoint(s.latitude,s.longitude,log.radial,log.distance),c=getReadabilityColor(log.readibility),m=L.circleMarker(d,{radius:6,color:c,fillColor:c,fillOpacity:0.9}),dt=formatDate(log.date)||'-',p=`<b>Log dari: ${s.name}</b><hr style="margin:5px 0"><b>Tanggal:</b> ${dt}<br><b>Callsign:</b> ${log.callsign||'-'}<br><b>Level:</b> FL${log.level||'-'}<br><b>Readability:</b> ${log.readibility||'-'}<br><b>Radial:</b> ${log.radial}Â°<br><b>Distance:</b> ${log.distance}nm`; m.bindPopup(p); const sc=s.sector; if(!logMarkersBySector[sc]){logMarkersBySector[sc]=[]} logMarkersBySector[sc].push(m)}}); filterBySector(); updateMarkerPopupsWithLogs(); buildSearchIndex()}).catch(e=>console.error('Gagal ambil data:',e)); }
    function initializeApp() { L.gridLayer.googleMutant({ type: 'roadmap' }).addTo(map); map.addLayer(stationClusterGroup); map.addLayer(logClusterGroup); }
    function onPolygonClick(e){const c=e.target.sectorName,s=$('#sector-select-box');let t=s.val()||[];const i=t.indexOf(c);if(i>-1){t.splice(i,1)}else{t.push(c)}s.val(t).trigger('change')}
    function createLayers(){const s=new Set();mapConfig.locations.forEach(l=>{s.add(l.sector);if(!sectorMarkers[l.sector]){sectorMarkers[l.sector]=[]}const i=L.AwesomeMarkers.icon({icon:'map-marker',prefix:'fa',markerColor:'blue'}),m=L.marker([l.latitude,l.longitude],{icon:i});m.bindTooltip(l.name,{sticky:!0});l._marker=m;sectorMarkers[l.sector].push(m)});for(const e in mapConfig.sectorPolygons){const o=L.polygon(mapConfig.sectorPolygons[e],{color:mapConfig.sectorColors[e]||'gray',weight:2,...invisibleStyle}).bindPopup(`<b>${e}</b><br>${mapConfig.sectorDescriptions[e]||"No description"}`).bindTooltip(e,{sticky:!0,direction:'center',className:'polygon-label'});o.sectorName=e;o.on('click',onPolygonClick);o.addTo(map);polygonLayers[e]=o}const t=$('#sector-select-box');t.empty();s.forEach(e=>{const o=new Option(e,e,!1,!1);t.append(o)});t.trigger('change')}
    function createCoverageLayers() {
        const coveragePromises = [];
        if (!mapConfig.sectorCoverageFiles) { return Promise.resolve([]); }
        for (const sector in mapConfig.sectorCoverageFiles) {
            const url = mapConfig.sectorCoverageFiles[sector];
            const promise = fetch(url)
                .then(response => response.ok ? response.json() : Promise.reject(`HTTP error! status: ${response.status}`))
                .then(data => ({ sector, data }));
            coveragePromises.push(promise);
        }
        return Promise.all(coveragePromises);
    }
    function buildSearchIndex(){const d=mapConfig.locations.map(l=>{const o=radioLogs[l.varname.toUpperCase()]||[],c=mapConfig.sectorDescriptions[l.sector]||'';return{...l,logs:o,frequency:c,_marker:l._marker}}),o={includeScore:!0,threshold:.3,keys:['name','varname','sector','logs.callsign','frequency']};fuse=new Fuse(d,o);console.log("Search index updated.")}
    function performSearch(){const e=document.getElementById('search-box'),t=e.value,o=$('#sector-select-box');if(t.trim()===''){o.val(null).trigger('change')}else{const c=fuse.search(t);if(c.length>0){const n=[...new Set(c.map(s=>s.item.sector))];o.val(n).trigger('change',['triggered_by_search'])}else{showNotification('Data tidak ditemukan')}}e.value=''}
    function filterBySector(){const s=$('#sector-select-box').val();if(!s||s.length===0){selectAll(!0);return}hideAllLayers();s.forEach(e=>{toggleSector(e,!0)})}
    function toggleSector(s,h){if(sectorMarkers[s]){sectorMarkers[s].forEach(m=>{h?stationClusterGroup.addLayer(m):stationClusterGroup.removeLayer(m)})}if(polygonLayers[s]){polygonLayers[s].setStyle(h?visibleStyle:invisibleStyle)}if(coverageLayers[s]){h?map.addLayer(coverageLayers[s]):map.removeLayer(coverageLayers[s])}if(logMarkersBySector[s]){logMarkersBySector[s].forEach(m=>{h?logClusterGroup.addLayer(m):logClusterGroup.removeLayer(m)})}}
    function selectAll(s){Object.keys(sectorMarkers).forEach(e=>toggleSector(e,s));if(s){$('#sector-select-box').val(null).trigger('change.select2');$('#search-box').val('')}}
    function hideAllLayers(){Object.keys(sectorMarkers).forEach(e=>toggleSector(e,!1))}
    function updateMarkerPopupsWithLogs(){mapConfig.locations.forEach(l=>{if(!l._marker)return;const t=l.varname.toUpperCase(),o=radioLogs[t];let c="No logs found for this station.";if(o&&o.length>0){c=o.slice(-5).map(s=>{const e=formatDate(s.date)||'-';return`Date: ${e} | ${s.callsign||'-'} | FL${s.level||'-'} | Read: ${s.readibility||'-'}`}).join("<br>")}const n=`<b>${l.name}</b> (${l.sector})<br><i>${l.varname}</i><br><small>${mapConfig.sectorDescriptions[l.sector]||""}</small><hr style="margin:5px 0"><b>Last Logs:</b><br>${c}`;l._marker.bindPopup(n)})}

    // Google akan memanggil fungsi ini secara otomatis
    function initMap() {
        $(document).ready(function() {
            fetch('config.json')
                .then(response => response.json())
                .then(configData => {
                    mapConfig = configData;
                    initializeApp();
                    createLayers();
                    
                    createCoverageLayers()
                        .then(results => {
                            results.forEach(result => {
                                const { sector, data } = result;
                                const geoJsonLayer = L.geoJSON(data, {
                                    style: feature => ({
                                        color: feature.properties.color, weight: 1,
                                        fillColor: feature.properties.color, fillOpacity: 0.5
                                    })
                                });
                                coverageLayers[sector] = geoJsonLayer;
                                console.log(`â Berhasil membuat layer coverage untuk: ${sector}`);
                            });

                            $('#sector-select-box').select2({
                                placeholder: 'Pilih satu/lebih sektor...',
                                allowClear: true
                            });
                            $('#sector-select-box').on('change', function (e, triggerSource) {
                                if (triggerSource !== 'triggered_by_search') { $('#search-box').val(''); }
                                filterBySector();
                            });
                            $('#search-box').on('keydown', function (event) {
                                if (event.key === 'Enter' || event.keyCode === 13) { performSearch(); }
                            });
                            $('#toggle-controls-btn').on('click', function() {
                                $('#controls').toggleClass('is-hidden');
                            });
                            
                            selectAll(true);
                            loadDynamicData();
                            buildSearchIndex();
                        })
                        .catch(error => {
                            console.error('Gagal memuat satu atau lebih file coverage:', error);
                        });
                })
                .catch(error => {
                    console.error('Gagal memuat file konfigurasi:', error);
                    document.getElementById('map').innerHTML = '<h2>Error: Gagal memuat data peta.</h2>';
                });
        });
    }
</script>
</body>
</html>
