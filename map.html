<!DOCTYPE html>

<html>

<head>

  <meta charset="utf-8" />

  <title>Peta Interaktif Marker + Polygon + Log</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.css"/>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.Default.css"/>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>

  <style>

    html, body, #map { height: 100%; margin: 0; padding: 0; }

    #controls {

      position: absolute; top: 10px; right: 10px;

      background: white; padding: 10px; z-index: 1000;

      border-radius: 6px; min-width: 200px; max-width: 250px;

    }

    .polygon-label {

      font-weight: bold; color: #000; background-color: rgba(255,255,255,0.85);

      padding: 2px 5px; border-radius: 4px; font-size: 12px;

      box-shadow: 0 0 2px rgba(0,0,0,0.3);

    }

/* Mengecilkan padding utama panel kontrol */
#controls {
    padding: 8px;
    min-width: 150px; /* Lebar minimum bisa dikurangi */
}

/* Mengecilkan semua teks judul/label */
#controls strong, 
#controls label {
    font-size: 13px;
    margin-bottom: 4px; /* Mengurangi jarak bawah */
}

/* Mengecilkan dropdown */
#sector-dropdown {
    height: 30px;
    padding: 4px 8px;
    font-size: 12px;
}

/* Mengecilkan tombol Expand/Collapse */
#controls .btn {
    padding: 3px 8px;
    font-size: 12px;
}

/* Mengecilkan input file */
#controls #file-upload {
    font-size: 12px;
    height: auto; /* Biarkan tinggi menyesuaikan */
    padding: 5px;
}

/* Mengurangi jarak garis pemisah */
#controls hr {
    margin: 8px 0;
}

    #upload-status { font-style: italic; font-size: 12px; color: #555; margin-top: 5px; }

@media (max-width: 600px) {
    #controls {
        top: 0;
        right: 0;
        left: 0;
        border-radius: 0;
        max-width: 100%;
    }
}

  </style>

  <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC-qCWLhkjYc9IYNztAWPmPatlxhCqKzR8"></script>

</head>

<body>



<div id="controls">

  <strong>Filter Sektor:</strong>

  <select id="sector-dropdown" class="form-control" onchange="filterByDropdown()">

    <option value="all">-- Semua Sektor --</option>

  </select>



  <div class="text-center" style="margin-top:8px;">

    <button class="btn btn-sm btn-primary" onclick="selectAll(true)">Expand All</button>

    <button class="btn btn-sm btn-danger" onclick="selectAll(false)">Collapse All</button>

  </div>



  <hr style="margin:10px 0;">

  <label for="file-upload">Upload File (.xlsx):</label>

  <input type="file" id="file-upload" accept=".xlsx" class="form-control">

  <div id="upload-status" class="text-center">Pilih file untuk memuat log.</div>

</div>



<div id="map"></div>



<script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>

// --- KONFIGURASI PETA DAN DATA ---

const mapConfig = {
    locations: [
        { name: "Cirebon", latitude: -6.698261448, longitude: 108.55981815, varname: "CRB UJOG", sector: "UJOG" },
        { name: "Pangandaran", latitude: -7.668601524, longitude: 108.72431672, varname: "PGN", sector: "UJOG" },
        { name: "Palembang", latitude: -2.894326494, longitude: 104.701946, varname: "PLB", sector: "UPLB" },
        { name: "Jakarta", latitude: -6.132542965, longitude: 106.634537, varname: "CKG UPLB", sector: "UPLB" },
        { name: "Pekanbaru", latitude: 0.459130454, longitude: 101.44784448, varname: "PKU", sector: "UPKU" },
        { name: "Jambi", latitude: -1.635302488, longitude: 103.64604351, varname: "DJB", sector: "UPKU" },
        { name: "Padang", latitude: -0.788403722, longitude: 100.2865148, varname: "PDG UPKU", sector: "UPKU" },
        { name: "Meulaboh", latitude: 4.047873848, longitude: 96.25028095, varname: "MEU", sector: "UBAC" },
        { name: "Gunung Linteung", latitude: 5.517778, longitude: 95.417222, varname: "GNLG", sector: "UBAC" },
        { name: "Tangkuban", latitude: -6.764764219, longitude: 107.6032479, varname: "TKB UBND", sector: "UBND" },
        { name: "Jakarta", latitude: -6.132542965, longitude: 106.634537, varname: "CKG UBND", sector: "UBND" },
        { name: "Kulonprogo", latitude: -7.903026654, longitude: 110.0660473, varname: "KLPG", sector: "UBND" },
        { name: "Cirebon", latitude: -6.698261448, longitude: 108.55981815, varname: "CRB USMG", sector: "USMG" },
        { name: "Tangkuban", latitude: -6.764764219, longitude: 107.60324787, varname: "TKB USMG", sector: "USMG" },
        { name: "Sidikalang", latitude: 2.6994, longitude: 98.30269722, varname: "SDKL", sector: "UMDN" },
        { name: "Sibiru-biru", latitude: 3.398888889, longitude: 98.67804722, varname: "SBR", sector: "UMDN" },
        { name: "Bengkulu", latitude: -3.796170863, longitude: 102.26566941, varname: "BKL", sector: "UIOS" },
        { name: "Padang", latitude: -0.787986331, longitude: 100.28643854, varname: "PDG UIOS", sector: "UIOS" },
        { name: "Nias", latitude: 1.38802537, longitude: 97.40798281, varname: "NIAS", sector: "UIOS" },
        { name: "Tanjung Pandan", latitude: -2.753, longitude: 107.75299722, varname: "TPD", sector: "UTPD" },
        { name: "Tangkuban", latitude: -6.764764219, longitude: 107.60324787, varname: "TKB UTPD", sector: "UTPD" },
        { name: "Tanjung Pinang", latitude: 0.922999978, longitude: 104.5199966, varname: "TNJ UTPG", sector: "UTPG" },
        { name: "Natuna", latitude: 3.963670015, longitude: 108.4000015, varname: "NTA UTPG", sector: "UTPG" },
        { name: "Tanjung Karang", latitude: -5.245661657, longitude: 105.178475, varname: "TKG", sector: "UJKT" },
        { name: "Jakarta", latitude: -6.132542965, longitude: 106.634537, varname: "CKG UJKT", sector: "UJKT" },
        { name: "Pangkal Pinang", latitude: -2.160398231, longitude: 106.1419171, varname: "PKP", sector: "UPKP" },
        { name: "Tanjung Pinang", latitude: 0.922999978, longitude: 104.5199966, varname: "TNJ UPKP", sector: "UPKP" },
        { name: "Matak", latitude: 3.34320013, longitude: 106.2569768, varname: "MTK", sector: "UNTA" },
        { name: "Natuna", latitude: 3.963670015, longitude: 108.4000015, varname: "NTA UNTA", sector: "UNTA" },
        { name: "Pontianak", latitude: 0.131439999, longitude: 109.4089966, varname: "PNK", sector: "UPNK" },
        { name: "Ketapang", latitude: -1.816029, longitude: 109.961583, varname: "KTP", sector: "UPNK" }
    ],
    sectorDescriptions: {
        "UNTA": "Primary Frequency: 134.025 MHz",
        "UMDN": "Primary: 133.2 MHz<br>Secondary: 133.45 MHz",
        "UTPD": "Primary: 125.7 MHz<br>Secondary: 133.9 MHz",
        "UBAC": "Primary: 128.3 MHz<br>Secondary: 132.2 MHz",
        "UIOS": "Primary: 132.85 MHz",
        "UTPG": "Primary: 133.325 MHz",
        "UPKU": "Primary: 132.3 MHz<br>Secondary: 135.85 MHz",
        "UPKP": "Primary: 132.9 MHz<br>Secondary: 135.6 MHz",
        "UBND": "Primary: 132.1 MHz<br>Secondary: 134.5 MHz",
        "USMG": "Primary: 120.9 MHz<br>Secondary: 135.8 MHz",
        "UJOG": "Primary: 125.2 MHz<br>Secondary: 134.3 MHz",
        "UPLB": "Primary: 132.7 MHz<br>Secondary: 134.75 MHz",
        "UPNK": "Primary: 133.5 MHz<br>Secondary: 134.45 MHz",
        "UJKT": "Primary: 135.9 MHz<br>Secondary: 132.15 MHz"
    },
    sectorColors: {
        "UNTA": "#FF0000", "UMDN": "#00AA00", "UTPD": "purple", "UBAC": "orange",
        "UIOS": "darkred", "UTPG": "#FF6600", "UPKU": "#0066CC", "UPKP": "#008000",
        "UBND": "#FF33A1", "USMG": "#33A1FF", "UJOG": "#FF8C00", "UPLB": "#FFD700",
        "UPNK": "#FF1100", "UJKT": "#6600CC"
    },
    sectorPolygons: {
        "UNTA": [
            [2.89,105.233611],[3.248056,105.438611],[3.290833,105.499722],
            [3.5125,105.858333],[4.22,107.295278],[4.638889,107.554167],
            [4.8675,107.773611],[4.984444,107.923611],[5.003333,108.025556],
            [4.95,108.271944],[2.847222,109.274722],[2.744444,106.503056],
            [2.89,105.233611]
        ],
        "UTPD": [
            [-2.4875,108.6675],[-3,110.383333],[-5.479167,110.383333],
            [-5.484722,108.876944],[-5.997778,107.268889],[-3.720833,107.252778],
            [-2.156667,106.140278],[-2.4875,108.6675]
        ],
        "UMDN": [
            [5.256389,98.2975],[2.211389,101.564167],[1.032222,100.875278],
            [-0.006111,97.841111],[2,96],[4.408611,97.189444],
            [5.256389,98.2975]
        ],
        "UBAC": [
            [6,92],[6,97.5],[5.256389,98.2975],
            [4.408611,97.189444],[2,96],[2,92],
            [6,92]
        ],
        "UIOS": [
            [2,96],[-0.006111,97.841111],[-3.589722,100.315556],
            [-8.23,103.516111],[-8.959722,102.439444],[-2,92],
            [2,92],[2,96]
        ],
        "UTPG": [
            [1.3,104.5],[1.489167,104.578056],[1.329722,104.768333],
            [2.310556,105.368056],[2.611389,105.219722],[2.73,105.148333],
            [2.836111,105.202778],[2.89,105.233611],[2.744444,106.503056],
            [2.847222,109.274722],[2.25,108.5],[1,108.5],
            [-0.113333,107.728333],[-0.833333,106],[0.903611,104.514444],
            [1.3,104.5]
        ],
        "UPKU": [
            [2.211389,101.564167],[1.65,102.166667],[1.575,102.398056],
            [-0.114722,103.1775],[-1.357778,103.808056],[-3.864722,102.332778],
            [-3.589722,100.315556],[-0.006111,97.841111],[1.032222,100.875278],
            [2.211389,101.564167]
        ],
        "UPKP": [
            [1.575,102.398056],[1.216667,103.5],[1.236111,103.526944],
            [1.2,103.65],[1.179444,103.670833],[1.133333,103.75],
            [1.25,104],[1.3,104.5],[0.903611,104.514444],
            [-0.833333,106],[-2.156944,106.140278],[-2.900556,106.669444],
            [-2.991667,106.103333],[-2.878611,104.653333],[-1.357778,103.808056],
            [-0.114722,103.174722],[1.575,102.398056]
        ],
        "UBND": [
            [-6.187778,106.529722],[-6.271667,106.886944],[-6.881944,107.512222],
            [-8.805,109.203889],[-8.796944,110.903889],[-12,114.5],
            [-12,107],[-8.959722,102.439444],[-8.23,103.516111],
            [-6.187778,106.529722]
        ],
        "USMG": [
            [-5.479167,110.383333],[-6.723056,110.383333],[-6.531667,108.586111],
            [-6.214444,107.328056],[-5.997778,107.268889],[-5.484722,108.876944],
            [-5.479167,110.383333]
        ],
        "UJOG": [
            [-6.214444,107.328056],[-6.531667,108.586111],[-6.723056,110.383333],
            [-8.333333,110.383333],[-8.796944,110.903889],[-8.805,109.203889],
            [-6.881944,107.512222],[-6.214444,107.328056]
        ],
        "UPLB": [
            [-1.357778,103.808056],[-2.878333,104.653333],[-3.649167,105.481111],
            [-5.26,106.213056],[-6.187778,106.529722],[-8.23,103.516111],
            [-3.589722,100.315556],[-3.864722,102.332778],[-1.357778,103.808056]
        ],
        "UJKT": [
            [-2.878611,104.653333],[-2.991667,106.103333],[-2.900556,106.669444],
            [-3.720833,107.252778],[-5.997778,107.268889],[-6.214444,107.328056],
            [-6.881944,107.512222],[-6.271667,106.886944],[-6.187778,106.529722],
            [-5.26,106.213056],[-3.649167,105.481111],[-2.878611,104.653333]
        ],
        "UPNK": [
            [-0.113333333,107.7283333],[1,108.5],[1,108.9],[1,108.9716667],[1.025555556,108.9680556],
            [1.033333333,108.9644444],[1.050277778,108.9608333],[1.061388889,108.9558333],[1.066111111,108.9544444],
            [1.070555556,108.9466667],[1.084166667,108.9422222],[1.092777778,108.9366667],[1.092777778,108.9291667],
            [1.095277778,108.9252778],[1.098055556,108.9252778],[1.101111111,108.9308333],[1.106111111,108.9316667],
            [1.113888889,108.9297222],[1.1175,108.9316667],[1.121944444,108.9313889],[1.122222222,108.9255556],
            [1.120277778,108.9219444],[1.122777778,108.9197222],[1.143888889,108.9083333],[1.150277778,108.9075],
            [1.154166667,108.9052778],[1.163888889,108.9080556],[1.170277778,108.915],[1.172222222,108.9222222],
            [1.170555556,108.9294444],[1.163888889,108.9425],[1.165277778,108.9475],[1.171388889,108.9594444],
            [1.174444444,108.9625],[1.175833333,108.9622222],[1.180833333,108.9613889],[1.180833333,108.9613889],
            [1.193611111,108.9569444],[1.193611111,108.9569444],[1.209166667,108.9522222],[1.211388889,108.9516667],
            [1.218611111,108.9533333],[1.255555556,108.9763889],[1.275,108.9847222],[1.289444444,108.9991667],
            [1.313888889,109.0186111],[1.327222222,109.0283333],[1.344722222,109.0361111],[1.372222222,109.0441667],
            [1.404444444,109.0455556],[1.428055556,109.04],[1.440555556,109.035],[1.451944444,109.0333333],
            [1.487222222,109.0366667],[1.504166667,109.0416667],[1.523611111,109.0513889],[1.524722222,109.0525],
            [1.535555556,109.0613889],[1.543888889,109.0705556],[1.576111111,109.1088889],[1.588055556,109.1252778],
            [1.603888889,109.1497222],[1.605555556,109.1525],[1.637777778,109.2172222],[1.651666667,109.2383333],
            [1.666944444,109.2525],[1.670555556,109.255],[1.678333333,109.2605556],[1.690555556,109.2658333],
            [1.716388889,109.2766667],[1.726388889,109.2788889],[1.738611111,109.2766667],[1.747777778,109.2772222],
            [1.783888889,109.2936111],[1.785277778,109.2972222],[1.785277778,109.2972222],[1.790277778,109.2947222],
            [1.790277778,109.2947222],[1.7925,109.2916667],[1.798888889,109.2938889],[1.805555556,109.2983333],
            [1.809722222,109.3044444],[1.822777778,109.3183333],[1.8325,109.3252778],[1.839722222,109.3275],
            [1.860277778,109.3277778],[1.872777778,109.3319444],[1.875,109.3327778],[1.882222222,109.3319444],
            [1.926388889,109.3141667],[1.931111111,109.3158333],[1.9375,109.3241667],[1.948611111,109.3313889],
            [1.950555556,109.3355556],[1.951388889,109.3641667],[1.950833333,109.3711111],[1.950277778,109.3755556],
            [1.950555556,109.3933333],[1.954166667,109.4186111],[1.958333333,109.4269444],[1.970833333,109.4411111],
            [1.98,109.4472222],[1.983333333,109.4530556],[1.987222222,109.4677778],[1.986666667,109.4763889],
            [1.989166667,109.4841667],[1.989722222,109.4858333],[1.991666667,109.515],[1.993333333,109.5252778],
            [1.992222222,109.5611111],[1.993888889,109.5741667],[2.000277778,109.5872222],[2.006944444,109.5927778],
            [2.014166667,109.5941667],[2.018333333,109.5961111],[2.0275,109.6],[2.053611111,109.6163889],
            [2.066666667,109.6213889],[2.0775,109.6297222],[2.083055556,109.6358333],[2.083333333,109.6397222],
            [2.081388889,109.6416667],[2.081388889,109.6416667],[2.072777778,109.6402778],[2.043611111,109.6377778],
            [1.984444444,109.6136111],[1.979444444,109.6025],[1.976111111,109.595],[1.970555556,109.5863889],
            [1.963888889,109.5819444],[1.936944444,109.5747222],[1.930833333,109.5675],[1.927777778,109.5602778],
            [1.928888889,109.5522222],[1.926944444,109.5375],[1.921388889,109.5361111],[1.896111111,109.5419444],
            [1.886944444,109.5438889],[1.875555556,109.5513889],[1.856944444,109.5508333],[1.848888889,109.5547222],
            [1.845555556,109.5608333],[1.845833333,109.5672222],[1.843888889,109.5730556],[1.840277778,109.5744444],
            [1.818333333,109.5744444],[1.810555556,109.5780556],[1.800555556,109.5972222],[1.799166667,109.6002778],
            [1.798333333,109.6052778],[1.803055556,109.6147222],[1.805555556,109.6261111],[1.800277778,109.6430556],
            [1.801666667,109.6513889],[1.795,109.6622222],[1.785555556,109.675],[1.781111111,109.6786111],
            [1.773055556,109.68],[1.758333333,109.6763889],[1.748611111,109.6702778],[1.7425,109.6663889],
            [1.730277778,109.6608333],[1.706111111,109.6641667],[1.691388889,109.6577778],[1.672222222,109.6569444],
            [1.651944444,109.6602778],[1.635,109.6533333],[1.628611111,109.6541667],[1.628055556,109.6544444],[1.619722222,109.6591667],
            [1.613888889,109.6669444],[1.614444444,109.6719444],[1.610833333,109.6808333],
            [1.603333333,109.6861111],[1.5925,109.6888889],[1.589166667,109.6922222],
            [1.581111111,109.7030556],[1.548333333,109.7347222],[1.541666667,109.7388889],
            [1.539722222,109.74],[1.529444444,109.7511111],[1.520833333,109.7655556],
            [1.509444444,109.7727778],[1.500833333,109.78],[1.499722222,109.7858333],
            [1.493888889,109.7933333],[1.486666667,109.7958333],[1.476666667,109.7916667],
            [1.462222222,109.8016667],[1.460833333,109.8069444],[1.463055556,109.8111111],
            [1.4675,109.8144444],[1.481111111,109.8241667],[1.481666667,109.8283333],
            [1.475555556,109.83],[1.453333333,109.8252778],[1.437222222,109.8286111],
            [1.426944444,109.8288889],[1.421666667,109.8341667],[1.421111111,109.8480556],
            [1.416388889,109.8605556],[1.415833333,109.8752778],[1.415277778,109.8866667],
            [1.423333333,109.9094444],[1.423888889,109.9197222],[1.418611111,109.9313889],
            [1.409166667,109.9405556],[1.405,109.9494444],[1.399722222,109.9558333],
            [1.393055556,109.9597222],[1.383055556,109.9613889],[1.371666667,109.9583333],
            [1.365555556,109.9586111],[1.363888889,109.9586111],[1.341944444,109.9647222],
            [1.338611111,109.9636111],[1.311944444,109.9722222],[1.297222222,109.9786111],
            [1.295555556,109.9836111],[1.295555556,109.9991667],[1.295277778,110],
            [1.290277778,110.0097222],[1.285555556,110.0141667],[1.279166667,110.0275],
            [1.278888889,110.0280556],[1.275,110.0327778],[1.265833333,110.0394444],
            [1.266111111,110.0527778],[1.261666667,110.0552778],[1.243611111,110.0602778],
            [1.241111111,110.0597222],[1.228611111,110.0627778],[1.223055556,110.0547222],
            [1.218888889,110.0533333],[1.215,110.0538889],[1.208611111,110.0586111],
            [1.2075,110.0608333],[1.213611111,110.0747222],[1.213055556,110.0808333],
            [1.208055556,110.0827778],[1.203055556,110.0847222],[1.196944444,110.0911111],
            [1.1975,110.1072222],[1.195277778,110.1130556],[1.194722222,110.1202778],
            [1.198055556,110.1316667],[1.2,110.1508333],[1.186388889,110.17],
            [1.182777778,110.1808333],[1.178611111,110.1877778],[1.172222222,110.1913889],
            [1.168888889,110.1933333],[1.158333333,110.2022222],[1.148333333,110.2061111],
            [1.143333333,110.2055556],[1.134444444,110.1991667],[1.126388889,110.2011111],
            [1.116388889,110.2063889],[1.111944444,110.2155556],[1.116111111,110.2225],
            [1.1175,110.2302778],[1.110555556,110.2391667],[1.091666667,110.2422222],
            [1.086388889,110.2438889],[1.081944444,110.2455556],[1.068611111,110.2577778],
            [1.064444444,110.2588889],[1.055277778,110.2577778],[1.0525,110.2605556],
            [1.048888889,110.2733333],[1.044444444,110.2788889],[1.039722222,110.2808333],
            [1.030277778,110.2713889],[1.023055556,110.2727778],[1.018055556,110.2752778],
            [1.011666667,110.2758333],[0.999166667,110.2716667],[0.993611111,110.2738889],
            [0.991111111,110.2791667],[0.992222222,110.2816667],[0.997222222,110.2963889],
            [1.002222222,110.3011111],[1.002777778,110.3091667],[0.993611111,110.3236111],
            [1.007777778,110.3269444],[1.006944444,110.3355556],[0.989444444,110.3427778],
            [0.983888889,110.3486111],[0.983055556,110.3575],[0.991388889,110.3744444],
            [0.993055556,110.3938889],[0.991111111,110.3977778],[0.979722222,110.4027778],
            [0.965277778,110.4058333],[0.9475,110.4033333],[0.945833333,110.4047222],
            [0.9475,110.4152778],[0.947222222,110.4216667],[0.939722222,110.435],
            [0.935,110.4372222],[0.926388889,110.4316667],[0.920833333,110.4358333],
            [0.912777778,110.4416667],[0.902777778,110.4583333],[0.897777778,110.4616667],
            [0.891944444,110.4633333],[0.889444444,110.4702778],[0.885833333,110.4747222],
            [0.880555556,110.4777778],[0.875555556,110.4972222],[0.869166667,110.5383333],
            [0.8675,110.5413889],[0.861944444,110.5508333],[0.855277778,110.5719444],
            [0.855833333,110.5772222],[0.86,110.5875],[0.868055556,110.6030556],
            [0.867222222,110.62],[0.877222222,110.6294444],[0.885833333,110.6316667],
            [0.904722222,110.6325],[0.908333333,110.6327778],[0.910277778,110.6347222],
            [0.908611111,110.6444444],[0.889444444,110.6497222],[0.8825,110.6552778],
            [0.879166667,110.6663889],[0.88,110.6794444],[0.884722222,110.6863889],
            [0.885277778,110.6908333],[0.892777778,110.7013889],[0.901666667,110.7088889],
            [0.906666667,110.7177778],[0.906388889,110.7263889],[0.906111111,110.7275],
            [0.903055556,110.7416667],[0.903333333,110.7525],[0.906666667,110.7563889],
            [0.923055556,110.7586111],[0.926944444,110.7608333],[0.930833333,110.7658333],
            [0.929444444,110.7725],[0.911111111,110.7838889],[0.902777778,110.8002778],
            [0.903055556,110.8041667],[0.9075,110.8091667],[0.916944444,110.8105556],
            [0.918055556,110.8108333],[0.923333333,110.81],[0.933333333,110.8044444],
            [0.9425,110.8044444],[0.945,110.8055556],[0.948055556,110.8105556],
            [0.953055556,110.8266667],[0.952777778,110.8538889],[0.953888889,110.8586111],
            [0.961666667,110.865],[0.976388889,110.8827778],[0.983888889,110.8863889],
            [0.990833333,110.89],[0.9975,110.8869444],[1.002777778,110.8863889],
            [1.008888889,110.8886111],[1.023888889,110.8977778],[1.029722222,110.9075],
            [1.029166667,110.9180556],[1.025,110.925],[1.028888889,110.9663889],[1.028611111,110.9758333],[1.025555556,110.9863889],
            [1.0275,110.9933333],[1.027222222,110.9991667],[1.029722222,111.0113889],
            [1.030277778,111.0219444],[1.033333333,111.0333333],[1.033888889,111.0436111],
            [1.048888889,111.0755556],[1.049444444,111.0936111],[1.048611111,111.0963889],
            [1.046388889,111.1072222],[1.051111111,111.1186111],[1.05,111.14],
            [1.054166667,111.1477778],[1.054722222,111.1536111],[1.059444444,111.1663889],
            [1.061388889,111.1930556],[1.069444444,111.2038889],[1.078333333,111.2122222],
            [1.079722222,111.2133333],[1.088333333,111.2186111],[1.086944444,111.2255556],
            [1.079722222,111.2369444],[1.065,111.2527778],[1.063333333,111.265],
            [1.048333333,111.2980556],[1.043333333,111.3202778],[1.041111111,111.3305556],
            [1.036666667,111.3344444],[1.028333333,111.3627778],[1.013055556,111.3836111],
            [1.011111111,111.3894444],[1.008055556,111.4172222],[1.013055556,111.4363889],
            [1.013611111,111.4391667],[1.018055556,111.4438889],[1.021944444,111.4505556],
            [1.03,111.4566667],[1.032777778,111.4613889],[1.0325,111.4819444],
            [1.030277778,111.4880556],[1.021666667,111.4977778],[1.010277778,111.5061111],
            [0.998055556,111.5116667],[0.972777778,111.5163889],[0.964166667,111.5180556],
            [0.9575,111.5216667],[0.953055556,111.5280556],[0.948888889,111.5413889],
            [0.949166667,111.5438889],[0.954722222,111.5477778],[0.963333333,111.5502778],
            [0.975833333,111.5452778],[0.981944444,111.5491667],[0.983055556,111.5588889],
            [0.979166667,111.5683333],[0.979444444,111.5747222],[0.983055556,111.5797222],
            [0.998333333,111.5847222],[1.003055556,111.5863889],[1.008888889,111.5991667],
            [1.01,111.605],[1.013888889,111.6125],[1.019722222,111.6188889],
            [1.019166667,111.6283333],[1.023333333,111.6341667],[1.030277778,111.6383333],
            [1.038611111,111.6577778],[1.04,111.6658333],[1.026944444,111.6822222],
            [1.026388889,111.6958333],[1.025833333,111.7083333],[1.021666667,111.7102778],
            [1.014444444,111.7066667],[1.007222222,111.7147222],[1.004166667,111.725],
            [1.004722222,111.7316667],[1.007777778,111.7372222],[1.008888889,111.7433333],
            [1.018055556,111.755],[1.018611111,111.7583333],[1.016111111,111.7625],
            [1.011111111,111.7663889],[1.005,111.7683333],[1.001388889,111.7736111],
            [0.996388889,111.7852778],[0.996388889,111.7902778],[0.996944444,111.8030556],
            [0.987222222,111.8197222],[0.987777778,111.8283333],[1.008888889,111.8588889],
            [1.0125,111.8625],[1.026111111,111.8688889],[1.036666667,111.8669444],
            [1.041111111,111.8677778],[1.052777778,111.8733333],[1.061666667,111.8777778],
            [1.068055556,111.8838889],[1.068611111,111.8966667],[1.071666667,111.9027778],
            [1.081388889,111.9058333],[1.085,111.9125],[1.086666667,111.9213889],
            [1.090277778,111.9252778],[1.096111111,111.9258333],[1.102777778,111.9286111],
            [1.114444444,111.9305556],[1.1175,111.9352778],[1.121666667,111.9533333],
            [1.121666667,111.9594444],[1.121388889,111.9747222],[1.124722222,111.9858333],
            [1.123611111,111.9955556],[1.128888889,112.0141667],[1.128055556,112.0141667],
            [1.126666667,112.0258333],[1.129166667,112.0383333],[1.131388889,112.0686111],
            [1.134722222,112.0819444],[1.133888889,112.0944444],[1.136111111,112.1311111],
            [1.139166667,112.1386111],[1.14,112.145],[1.165833333,112.1488889],
            [1.172222222,112.1463889],[1.176944444,112.1408333],[1.179444444,112.14],
            [1.194166667,112.1511111],[1.194722222,112.1513889],[1.213611111,112.1583333],
            [1.220555556,112.1625],[1.244166667,112.1561111],[1.249444444,112.1580556],
            [1.253611111,112.1661111],[1.257777778,112.1697222],[1.278333333,112.1638889],
            [1.283888889,112.1652778],[1.293888889,112.1716667],[1.305277778,112.1747222],
            [1.306944444,112.1763889],[1.313055556,112.1833333],[1.315555556,112.1886111],
            [1.332222222,112.2047222],[1.34,112.2077778],[1.349722222,112.2063889],
            [1.358888889,112.2152778],[1.386666667,112.2219444],[1.395,112.2213889],
            [1.397777778,112.215],[1.405833333,112.2063889],[1.406111111,112.2052778],
            [1.4075,112.2011111],[1.406388889,112.1958333],[1.409722222,112.1925],
            [1.419722222,112.1991667],[1.432777778,112.1977778],[1.441388889,112.2008333],
            [1.449444444,112.2077778],[1.456666667,112.2219444],[1.458611111,112.2463889],
            [1.463611111,112.2575],[1.463333333,112.2702778],[1.463611111,112.2708333],
            [1.466666667,112.2755556],[1.479722222,112.2861111],[1.490833333,112.3041667],
            [1.502777778,112.3158333],[1.503888889,112.3208333],[1.5025,112.3527778],
            [1.511388889,112.3797222],[1.512222222,112.3825],[1.522777778,112.3930556],
            [1.521111111,112.3980556],[1.5175,112.4008333],[1.5225,112.4133333],
            [1.522222222,112.4241667],[1.525833333,112.4305556],[1.534444444,112.4369444],
            [1.549166667,112.4413889],[1.571388889,112.4752778],[1.573055556,112.4777778],
            [1.5775,112.4925],[1.577222222,112.5008333],[1.573888889,112.5102778],
            [1.574444444,112.5222222],[1.570833333,112.5341667],[1.569722222,112.5936111],
            [1.568611111,112.5983333],[1.568055556,112.6016667],[1.567777778,112.615],
            [1.564166667,112.6283333],[1.564722222,112.6372222],[1.566944444,112.6436111],
            [1.566666667,112.6538889],[1.553055556,112.6688889],[1.55,112.6741667],
            [1.551111111,112.6938889],[1.5575,112.7058333],[1.558888889,112.7152778],[1.559166667,112.7172222],
            [1.563055556,112.7258333],[1.5625,112.7322222],[1.559166667,112.7391667],
            [1.559166667,112.7427778],[1.555555556,112.7472222],[1.555555556,112.7547222],
            [1.56,112.7675],[1.559166667,112.7777778],[1.554722222,112.7877778],
            [1.5425,112.8],[1.5375,112.8127778],[1.538055556,112.8197222],
            [1.542777778,112.8261111],[1.543055556,112.8286111],[1.543611111,112.8322222],
            [1.538611111,112.8388889],[1.546111111,112.8466667],[1.555833333,112.8502778],
            [1.559722222,112.8594444],[1.578888889,112.8766667],[1.585555556,112.89],
            [1.586388889,112.8983333],[1.569444444,112.9261111],[1.569444444,112.9275],
            [1.568055556,112.9347222],[1.570555556,112.9536111],[1.567222222,112.9583333],
            [1.566666667,112.9636111],[1.564444444,112.9686111],[1.565833333,112.9797222],
            [1.576388889,112.9841667],[1.579722222,112.9875],[1.578055556,112.9941667],
            [1.5725,112.9997222],[1.566944444,113.0097222],[1.566111111,113.0247222],
            [1.563888889,113.0347222],[1.562222222,113.0383333],[1.556111111,113.0511111],
            [1.556944444,113.0552778],[1.553888889,113.0577778],[1.5475,113.0583333],
            [1.535,113.0666667],[1.531666667,113.0675],[1.528888889,113.065],
            [1.5275,113.0566667],[1.522222222,113.0502778],[1.513055556,113.0441667],
            [1.498888889,113.0455556],[1.495555556,113.0436111],[1.493333333,113.0361111],
            [1.487222222,113.0327778],[1.478055556,113.0375],[1.473611111,113.0377778],
            [1.469166667,113.0341667],[1.466388889,113.02],[1.455555556,113.0038889],
            [1.450277778,112.9858333],[1.439722222,112.9738889],[1.432222222,112.9725],
            [1.406944444,112.9738889],[1.405555556,112.9925],[1.405555556,112.9936111],
            [1.401666667,113.0116667],[1.4025,113.0177778],[1.412222222,113.035],
            [1.420555556,113.0411111],[1.418333333,113.0566667],[1.426944444,113.0680556],
            [1.4275,113.0880556],[1.438055556,113.0897222],[1.441944444,113.0927778],
            [1.442222222,113.0969444],[1.442777778,113.1019444],[1.435555556,113.1083333],
            [1.430833333,113.12],[1.424722222,113.1238889],[1.419444444,113.1202778],
            [1.413055556,113.1236111],[1.409444444,113.1308333],[1.394722222,113.1336111],
            [1.390833333,113.1363889],[1.386111111,113.1447222],[1.386666667,113.1663889],
            [1.382222222,113.1772222],[1.376388889,113.1811111],[1.375555556,113.1816667],
            [1.378888889,113.1886111],[1.379444444,113.2005556],[1.381944444,113.2125],
            [1.386111111,113.2202778],[1.393888889,113.2280556],[1.392777778,113.2369444],
            [1.388055556,113.2425],[1.381944444,113.2458333],[1.380555556,113.2516667],
            [1.388055556,113.2655556],[1.386388889,113.27],[1.378888889,113.2744444],
            [1.378888889,113.2863889],[1.377777778,113.2888889],[1.373888889,113.2986111],
            [1.375833333,113.3163889],[1.363611111,113.3316667],[1.357222222,113.3502778],
            [1.351944444,113.3561111],[1.345277778,113.3591667],[1.328333333,113.3613889],
            [1.323055556,113.3658333],[1.318055556,113.3844444],[1.316666667,113.3891667],
            [1.312777778,113.3966667],[1.291111111,113.4088889],[1.285555556,113.4161111],
            [1.28,113.4397222],[1.301944444,113.4608333],[1.304444444,113.4655556],
            [1.306944444,113.4822222],[1.307777778,113.4833333],
            [1.315277778,113.4933333],[1.315555556,113.5016667],
            [1.311944444,113.5097222],[1.312777778,113.5163889],
            [1.318055556,113.5269444],[1.318888889,113.5341667],
            [1.316388889,113.5433333],[1.313055556,113.5483333],
            [1.305833333,113.5541667],[1.303055556,113.5686111],
            [1.303055556,113.5741667],[1.301666667,113.5769444],
            [1.284722222,113.585],[1.281666667,113.5841667],
            [1.280277778,113.5838889],[1.269166667,113.5891667],
            [1.258055556,113.5911111],[1.216666667,113.5833333],
            [-1.719722222,111.355],[-3,110.3833333],[-2.4875,108.6675],
            [-2.156944444,106.1402778],[-0.833333333,106],
            [-0.113333333,107.7283333]
        ]
    }
};


// --- INISIALISASI PETA & VARIABEL GLOBAL ---
const map = L.map("map").setView([-2.5, 117.0], 5);
const stationClusterGroup = L.markerClusterGroup();
const logClusterGroup = L.markerClusterGroup();
let polygonLayers = {};
let sectorMarkers = {};
let logMarkersBySector = {};
let radioLogs = {};

// --- FUNGSI-FUNGSI HELPER ---

function calculateDestinationPoint(lat, lon, bearing, distanceNm) {
    const R = 6371; // Radius Bumi dalam km
    const distanceKm = distanceNm * 1.852; // Konversi mil laut ke km

    const latRad = (lat * Math.PI) / 180;
    const lonRad = (lon * Math.PI) / 180;
    const bearingRad = (bearing * Math.PI) / 180;

    const lat2Rad = Math.asin(Math.sin(latRad) * Math.cos(distanceKm / R) +
        Math.cos(latRad) * Math.sin(distanceKm / R) * Math.cos(bearingRad));

    const lon2Rad = lonRad + Math.atan2(Math.sin(bearingRad) * Math.sin(distanceKm / R) * Math.cos(latRad),
        Math.cos(distanceKm / R) - Math.sin(latRad) * Math.sin(lat2Rad));

    const lat2 = (lat2Rad * 180) / Math.PI;
    const lon2 = (lon2Rad * 180) / Math.PI;

    return [lat2, lon2];
}

function getReadabilityColor(readability) {
    const r = parseInt(readability, 10); // Pastikan nilainya angka

    if (r >= 4) { // Nilai 4 dan 5
        return 'green';
    } else if (r >= 2) { // Nilai 2 dan 3
        return 'yellow';
    } else if (r === 1) { // Nilai 1
        return 'red';
    } else {
        return 'grey'; // Warna default jika nilainya aneh/kosong
    }
}

function formatDate(date) {
    if (!(date instanceof Date) || isNaN(date)) {
        return date; // Kembalikan apa adanya jika tidak valid
    }
    const day = date.getDate();
    const month = date.getMonth() + 1; // getMonth() dimulai dari 0
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}
  
  // --- FUNGSI-FUNGSI UTAMA APLIKASI ---
/** Fungsi untuk mengambil data dinamis dari Google Sheet */
function loadDynamicData() {
    const apiUrl = 'https://script.google.com/macros/s/AKfycbysOsW_I0X2UxA6Gl0KwfFtFwG39imuqM4qfPPDl_alNh1TBWBIPB9kbbYvbKU3OZE/exec';

    fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
            console.log("Data dari Google Sheet:", data); // Untuk debugging
            
            data.forEach(item => {
                const lat = item.Latitude;
                const lon = item.Longitude;
                const nama = item.Nama;

                if (lat && lon) {
                    const marker = L.marker([lat, lon]);
                    if (nama) {
                        marker.bindPopup(`<b>${nama}</b> (From AppSheet)`);
                    }
                    stationClusterGroup.addLayer(marker);
                }
            });
        })
        .catch(error => console.error('Gagal mengambil data dari Google Sheet:', error));
}

/** Menginisialisasi peta, layer, dan UI listeners */
function initializeApp() {
   L.gridLayer.googleMutant({
        type: 'roadmap' // atau 'satellite', 'hybrid', 'terrain'
    }).addTo(map);

    map.addLayer(stationClusterGroup);
    map.addLayer(logClusterGroup);
    createLayers();
  loadDynamicData();
    setupUIListeners();
    selectAll(true);
}
/** Membuat semua layer polygon dan marker dari mapConfig */
function createLayers() {
    const sectors = new Set();
const dropdownOptions = [];

    // Proses marker dan kumpulkan nama sektor unik
    mapConfig.locations.forEach(loc => {
        sectors.add(loc.sector);
        
        if (!sectorMarkers[loc.sector]) {
            sectorMarkers[loc.sector] = [];
        }

        const icon = L.AwesomeMarkers.icon({ icon: 'map-marker', prefix: 'fa', markerColor: 'blue' });
        const marker = L.marker([loc.latitude, loc.longitude], { icon: icon });
        
        marker.bindTooltip(loc.name, { sticky: true });
        loc._marker = marker; // Simpan referensi marker
        sectorMarkers[loc.sector].push(marker);
    });

    // Buat layer polygon
    for (const sector in mapConfig.sectorPolygons) {
        const polygon = L.polygon(mapConfig.sectorPolygons[sector], {
            color: mapConfig.sectorColors[sector] || 'gray',
            weight: 2,
            fillOpacity: 0.3
        }).bindPopup(`<b>${sector}</b><br>${mapConfig.sectorDescriptions[sector] || "No description"}`)
          .bindTooltip(sector, { sticky: true, direction: 'center', className: 'polygon-label' });
        
        polygonLayers[sector] = polygon;
    }

    // Isi dropdown dari daftar sektor yang unik
    sectors.forEach(sec => {
        dropdownOptions.push(`<option value="${sec}">${sec}</option>`);
    });
    $('#sector-dropdown').append(dropdownOptions.join(''));
}

/** Menyiapkan semua event listener untuk UI */
function setupUIListeners() {
    $('#file-upload').on('change', handleFileUpload);
    // Listener untuk dropdown diletakkan di HTML: onchange="filterByDropdown()"
}

// --- LOGIKA FILTER DAN TOGGLE ---

function toggleSector(sector, show) {
    if (sectorMarkers[sector]) {
        sectorMarkers[sector].forEach(marker => {
            show ? stationClusterGroup.addLayer(marker) : stationClusterGroup.removeLayer(marker);
        });
    }
    if (polygonLayers[sector]) {
        show ? map.addLayer(polygonLayers[sector]) : map.removeLayer(polygonLayers[sector]);
    }
 if (logMarkersBySector[sector]) {
        logMarkersBySector[sector].forEach(marker => {
            show ? logClusterGroup.addLayer(marker) : logClusterGroup.removeLayer(marker);
        });
    }
}

function selectAll(state) {
    Object.keys(sectorMarkers).forEach(sector => toggleSector(sector, state));
    $('#sector-dropdown').val('all');
}

function filterByDropdown() {
    const selected = $('#sector-dropdown').val();
    if (selected === 'all') {
        selectAll(true);
    } else {
        selectAll(false);
        toggleSector(selected, true);
    }
}

// --- LOGIKA UPLOAD & PROSES FILE LOG ---

function handleFileUpload(event) {
    const file = event.target.files[0];
    const statusDiv = $('#upload-status');
    if (!file) return;

    statusDiv.text("Memproses file...").css('color', 'blue');
    
    logClusterGroup.clearLayers(); 
    radioLogs = {};
    logMarkersBySector = {}; // Reset data log per sektor

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
 const stationsMap = {};
            mapConfig.locations.forEach(loc => {
                stationsMap[loc.varname.toUpperCase()] = loc;
            });
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(sheet);

            jsonData.forEach(log => {
                const stationVarname = (log.radio_id || "").trim().toUpperCase();

 const station = stationsMap[stationVarname];

                if (stationVarname && !radioLogs[stationVarname]) {
                    radioLogs[stationVarname] = [];
                }
                if(stationVarname) radioLogs[stationVarname].push(log);
                
                if (station && log.radial != null && log.distance != null) {
                    const destination = calculateDestinationPoint(station.latitude, station.longitude, log.radial, log.distance);
                    const markerColor = getReadabilityColor(log.readibility);

                    const logMarker = L.circleMarker(destination, {
                        radius: 6,
                        color: markerColor,
                        fillColor: markerColor,
                        fillOpacity: 0.9
                    });
                    
                    const popupContent = `
                        <b>Log Entry (From: ${station.name})</b><hr style="margin: 5px 0;">
                        <b>Callsign:</b> ${log.callsign || '-'}<br>
                        <b>Level:</b> FL${log.level || '-'}<br>
                        <b>Via:</b> ${log.checkpoint || '-'}<br>
                        <b>Readability:</b> ${log.readibility || '-'}<br>
                    `;
                    logMarker.bindPopup(popupContent);

                    // MODIFIKASI 2: Simpan marker ke object logMarkersBySector
                    const sector = station.sector;
                    if (!logMarkersBySector[sector]) {
                        logMarkersBySector[sector] = [];
                    }
                    logMarkersBySector[sector].push(logMarker);
                }
            });
            
            updateMarkerPopupsWithLogs();
            statusDiv.text(`Visualisasi ${jsonData.length} log berhasil!`).css('color', 'green');
            
            // MODIFIKASI 3: Panggil ulang filter untuk menyegarkan tampilan log
            filterByDropdown(); 

        } catch (error) {
            console.error("Error saat memproses file:", error);
            statusDiv.text("Error: Gagal memproses file.").css('color', 'red');
        }
    };
    reader.readAsArrayBuffer(file);
}
function updateMarkerPopupsWithLogs() {
    mapConfig.locations.forEach(loc => {
        if (!loc._marker) return;

        const varnameUpper = loc.varname.toUpperCase();
        const logs = radioLogs[varnameUpper];
        let logText = "No logs found for this station.";

        if (logs && logs.length > 0) {
            logText = logs.slice(-5).map(log => {
                const date = formatDate(log.date) || '-'; 
                const callsign = log.callsign || '-';
                const level = log.level || '-';
                const readability = log.readibility || '-';
                const radial = log.radial || '-';
                const distance = log.distance || '-';
                const checkpoint = log.checkpoint || '-';

                return `Date: ${date} | ${callsign} | FL${level} | Rad: ${radial} | Dist: ${distance}nm | Via: ${checkpoint} | Read: ${readability}`;
            }).join("<br>");
        }

        const popupContent = `
            <b>${loc.name}</b> (${loc.sector})<br>
            <i>${loc.varname}</i><br>
            <small>${mapConfig.sectorDescriptions[loc.sector] || ""}</small>
            <hr style="margin: 5px 0;">
            <b>Last Logs:</b><br>${logText}
        `;
        loc._marker.bindPopup(popupContent);
    });
}

// --- JALANKAN APLIKASI ---
$(document).ready(initializeApp);
</script>
</body>
</html>
